# PaletAI Project Rules

## üö´ Critical Rules - NEVER DO THESE

### Git Workflow
- **NEVER push directly to `deploy` branch**
  - The `deploy` branch is for automatic releases only
  - Always work on `main` branch
  - GitHub Actions automatically handles deployment when `deploy` branch is updated through proper workflow

### Code Quality
- **NEVER use emojis in code** unless explicitly requested by the user
- **ALWAYS run linter checks** after making changes
- **ALWAYS use default exports** for React hooks and components when there's only one export

---

## üéØ Project Structure

### Core Architecture
- **Framework**: Electron + React + TypeScript + Vite
- **UI Library**: HeroUI (NextUI fork)
- **State Management**: React hooks + localStorage
- **Webview Management**: Electron webview elements for AI service iframes

### Key Directories
```
src/
‚îú‚îÄ‚îÄ components/         # React components
‚îú‚îÄ‚îÄ constants/          # AI service configurations
‚îú‚îÄ‚îÄ hooks/              # Custom React hooks
‚îî‚îÄ‚îÄ App.tsx            # Main application component

electron/
‚îú‚îÄ‚îÄ index.ts           # Main Electron process
‚îî‚îÄ‚îÄ preload.ts         # Preload script for IPC
```

---

## ‚ûï Adding a New AI Service

When adding a new AI service (e.g., "NewAI"), update these files in order:

### 1. **src/constants/aiServices.ts**
```typescript
export const AI_SERVICES: Record<string, AIServiceConfig> = {
  // ... existing services
  newai: {
    name: 'newai',
    displayName: 'NewAI',
    url: 'https://newai.example.com/',
    partition: 'persist:newai',
    selector: 'textarea[placeholder="..."]',  // Input field selector
    buttonSelector: 'button[type="submit"]',   // Send button selector
    color: 'blue'  // Color for UI elements
  }
};
```

### 2. **src/hooks/useLocalStorage.ts**
- Add to `EnabledServices` interface: `newai: boolean;`
- Add to `LastUrls` interface: `newai: string;`
- Update `isValidEnabledServices()` to include `'newai'`
- Update `isValidLastUrls()` to include `'newai'`

### 3. **src/hooks/useWebviewManager.ts**
- Add to `WebviewRefs`: `newaiRef: React.RefObject<WebviewElement>;`
- Add to `WebviewsReady`: `newai: boolean;`
- Create ref: `const newaiRef = useRef<WebviewElement>(null);`
- Update `checkWebviewsReady` to check `newaiReady`
- Return `newaiRef` in the refs object

### 4. **src/App.tsx**
- Update `lastUrls` initial state to include: `newai: AI_SERVICES.newai.url`
- Add `newaiRef` to the destructured `refs`
- Add to `handleNewChat`: `newaiRef.current.loadURL(AI_SERVICES.newai.url)`
- Add to `handleSendToAll`: send logic for NewAI
- Add `<WebviewPanel>` component for NewAI
- Update default `enabledServices` if needed

### 5. **src/components/ServiceSelector.tsx**
- Add a new `Checkbox` for NewAI with tooltip support

### 6. **src/components/DeveloperTools.tsx**
- Add `newaiRef` to `DeveloperToolsProps`
- Add DevTools and DOM analysis buttons for NewAI

### 7. **README.md**
- Add NewAI to the list of supported services
- Update feature descriptions

### 8. **package.json**
- Bump version number (follow semantic versioning)

### 9. **CHANGELOG.md**
- Add entry under new version section describing the addition

---

## üìù Version Management

### Semantic Versioning (MAJOR.MINOR.PATCH)
- **MAJOR** (x.0.0): Breaking changes, major overhauls
- **MINOR** (0.x.0): New features, new AI services
- **PATCH** (0.0.x): Bug fixes, minor improvements

### When Updating Version:

1. **package.json**: Update `version` field
2. **CHANGELOG.md**: Add new version section at the top
3. **README.md**: Update version badge
4. Commit changes to `main` branch
5. **DO NOT** manually push to `deploy` branch
6. GitHub Actions will handle the release automatically

---

## üìã CHANGELOG.md Format

Always use this structure:

```markdown
# Changelog

## [1.0.X] - YYYY-MM-DD

### ‚ú® Features
- Feature description with details

### üé® UI/UX Improvements
- UI/UX improvement description

### üêõ Bug Fixes
- Bug fix description

### üîÑ Performance
- Performance improvement description

### ‚öôÔ∏è Developer Experience
- DX improvement description

## [Previous versions...]
```

**Key Points:**
- Use emoji prefixes (‚ú® üé® üêõ üîÑ ‚öôÔ∏è)
- Be specific and detailed
- Group related changes together
- Include technical details when relevant

---

## üé® Layout Constraints

### Grid Layout (2x2)
- **Maximum 4 services** can be selected
- Automatically switches to "Row" layout if > 4 services are selected
- Disable Grid option in LayoutSelector when > 4 services
- Show tooltip: "Grid layout supports up to 4 selections"
- Disable service checkboxes in ServiceSelector when at limit

### Implementation
- `ServiceSelector`: Check `layoutType === 'grid' && selectedCount >= 4`
- `LayoutSelector`: Check `selectedCount > 4` to disable Grid
- `App.tsx`: Auto-switch useEffect when grid + > 4 services

---

## üîß Common Patterns

### localStorage Keys
```typescript
const STORAGE_KEYS = {
  ENABLED_SERVICES: 'enabledServices',
  LAST_URLS: 'lastUrls',
  LAYOUT_TYPE: 'layoutType',
  ZOOM_LEVEL: 'zoomLevel'
};
```

### Sending Messages to AI Services
```typescript
await sendToAI(
  serviceRef,
  AI_SERVICES.service.selector,
  AI_SERVICES.service.buttonSelector,
  prompt,
  AI_SERVICES.service.displayName
);
```

### Timeout for Send Operations
- Use `setTimeout` with 1000ms delay in `finally` block
- Prevents race conditions when sending to multiple services
- Ensures `isSending` state is properly managed

---

## üß™ Testing Checklist

Before committing changes:

- [ ] Run `npm run lint` - no errors
- [ ] Test all enabled services receive messages
- [ ] Test Grid layout with 4 and 5 services
- [ ] Test New Chat functionality
- [ ] Test zoom controls (if modified)
- [ ] Test DevTools for each service
- [ ] Test Reset functionality
- [ ] Verify localStorage persistence

---

## üîó External Links

### Opening Links in Default Browser
Always use `window.Main.OpenExternalLink(url)` for external links:
```typescript
<button onClick={() => window.Main.OpenExternalLink('https://...')}>
  Link Text
</button>
```

**Never use** `<a href="...">` for external links in the Electron app.

---

## üéØ UI/UX Guidelines

### Tooltips
- Use HeroUI's `Tooltip` component
- Set `delay={0}` and `closeDelay={0}` for instant response
- Use `bg-gray-800 text-white text-xs px-2 py-1 rounded` for consistent styling
- Show informative messages, especially for disabled states

### Buttons
- Use semantic colors: primary (blue), danger (red), secondary (gray)
- Include `aria-label` for icon-only buttons
- Add hover/active states for feedback
- Use appropriate size variants (`sm`, `md`, `lg`)

### Responsive Design
- Use `flex-wrap` for control areas that should wrap on small screens
- Test on different screen sizes
- Hide non-essential text on mobile with `max-sm:hidden`

---

## üîç Finding DOM Selectors

When adding a new AI service:

1. Open the AI service website in the app
2. Click "Dev Tools" for that service
3. Click "Analyze DOM" to log all input and button elements
4. Check the console for logged selectors
5. Use the most specific and stable selector
6. Test with `buttonSelector` fallbacks if needed (comma-separated)

Example:
```typescript
selector: 'div.ProseMirror[contenteditable="true"]',
buttonSelector: 'button[type="submit"][aria-label="Send"], button[type="submit"]'
```

---

## ‚ö° Performance Considerations

### Webview Management
- Use `useCallback` for functions passed to webviews
- Memoize computed values with `useMemo`
- Check webview ready state before operations
- Handle webview errors gracefully

### State Updates
- Batch related state updates
- Use functional updates for state depending on previous state
- Debounce frequent updates when appropriate

---

## üêõ Common Issues & Solutions

### Issue: "Element not found" when sending
**Solution**: Check if webview is ready and selector is correct

### Issue: Grid layout breaks with 5+ services
**Solution**: Auto-switch to Row layout (already implemented)

### Issue: Zoom level resets on restart
**Solution**: Ensure `zoomLevel` is saved to localStorage

### Issue: Login sessions lost
**Solution**: Check webview `partition` is set correctly

### Issue: External links open in app
**Solution**: Use `window.Main.OpenExternalLink()` instead of `<a href>`

---

## üì¶ Build & Release

### Building the App
```bash
# macOS ARM64 (Apple Silicon)
npm run build:mac

# Windows
npm run build:win

# All platforms
npm run build
```

### Release Process (Automated)
1. Update `package.json` version
2. Update `CHANGELOG.md` with changes
3. Update `README.md` if needed
4. Commit to `main` branch: `git push origin main`
5. **DO NOT PUSH TO DEPLOY BRANCH**
6. Manually trigger release or wait for automated process
7. GitHub Actions builds and creates release automatically

### Homebrew Tap Update
- Automatically handled by GitHub Actions
- Updates `cha2hyun/homebrew-tap` repository
- Users can install with: `brew install --cask cha2hyun/tap/palet-ai`

---

## üéì Key Learnings from Development

### Race Condition in Message Sending
- **Problem**: `setTimeout` too short (300ms) for 5 services
- **Solution**: Wrap in try-finally, use 1000ms timeout
- **Reason**: Each service takes 100+ms, sequential await needed

### Layout Auto-Switching
- **Problem**: Users with grid + 5 services had broken layout
- **Solution**: useEffect to auto-switch to row when invalid
- **Location**: App.tsx, runs on layout/services change

### Default Export vs Named Export
- **Rule**: Use default export for single-export files
- **Reason**: ESLint rule "Prefer default export"
- **Example**: useAIServices.ts changed to default export

### Zoom Level Default
- **Change**: -1 ‚Üí 0 for first launch
- **Reason**: Users expect normal size on first use
- **Implementation**: Check in useEffect, set 0 if not exists

---

## üí° Best Practices

1. **Always validate localStorage data** - Use type guards
2. **Handle webview errors** - Check ready state first
3. **Test with all services** - Don't assume one works for all
4. **Use semantic commits** - feat:, fix:, docs:, refactor:, etc.
5. **Update all related files** - Don't leave partial implementations
6. **Check linter before commit** - Fix warnings and errors
7. **Document complex logic** - Future you will thank you
8. **Test edge cases** - Empty states, max limits, errors

---

## üîí Security Notes

- Each AI service uses isolated partition (`persist:servicename`)
- Webviews are sandboxed from main process
- No API keys stored - users login directly to services
- Local storage only contains UI preferences and URLs

---

## üìö Additional Resources

- **Electron Docs**: https://www.electronjs.org/docs
- **React Docs**: https://react.dev
- **HeroUI**: https://github.com/bolio-ui/bolio-ui (NextUI fork)
- **TypeScript**: https://www.typescriptlang.org/docs

---

## ‚úÖ Pre-Commit Checklist

Before every commit, ensure:

- [ ] Code compiles without TypeScript errors
- [ ] No ESLint warnings or errors
- [ ] All modified files are formatted consistently
- [ ] No console.log() statements left in production code
- [ ] Comments are clear and necessary
- [ ] Variable names are descriptive
- [ ] No hardcoded values that should be constants
- [ ] Git commit message follows conventions (feat:, fix:, etc.)
- [ ] Related files (CHANGELOG, README, package.json) are updated

---

**Remember**: This is a desktop app that runs multiple AI services simultaneously. Every change should consider performance, user experience, and the multi-service nature of the application.

